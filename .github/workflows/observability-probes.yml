name: Observability probes

on:
  workflow_call:
    inputs:
      environment:
        description: Target environment label
        required: false
        type: string
    secrets:
      PROBE_BASE_URL:
        required: false
      PROBE_METRICS_TOKEN:
        required: false
      PAGERDUTY_ROUTING_KEY:
        required: false
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment label
        type: choice
        options:
          - production
          - staging
        default: production

jobs:
  probe:
    name: Probe ${{ inputs.environment || github.event.inputs.environment || 'production' }} surface
    runs-on: ubuntu-latest
    env:
      TARGET_ENVIRONMENT: ${{ inputs.environment || github.event.inputs.environment || 'production' }}
    outputs:
      failures: ${{ steps.run-probes.outputs.failures }}
      environment: ${{ steps.run-probes.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run probes
        id: run-probes
        shell: bash
        env:
          BASE_URL: ${{ secrets.PROBE_BASE_URL }}
          METRICS_TOKEN: ${{ secrets.PROBE_METRICS_TOKEN }}
          PROBE_ENVIRONMENT: ${{ env.TARGET_ENVIRONMENT }}
        run: |
          if [[ -z "${BASE_URL:-}" ]]; then
            echo "::error title=Missing secret::PROBE_BASE_URL secret must be configured" >&2
            exit 1
          fi

          set +e
          bash scripts/ci/probe-endpoints.sh
          status=$?
          set -e

          failures="${status}"
          if [[ -f artifacts/failures.count ]]; then
            failures=$(cat artifacts/failures.count)
          fi

          echo "failures=${failures}" >>"${GITHUB_OUTPUT}"
          echo "environment=${PROBE_ENVIRONMENT}" >>"${GITHUB_OUTPUT}"

          exit ${status}

      - name: Upload probe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observability-probes
          path: artifacts

  page:
    name: Page on failure (${{ needs.probe.outputs.environment || 'production' }})
    needs: probe
    if: ${{ always() && (needs.probe.result == 'failure' || (needs.probe.outputs.failures || '0') != '0') }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger PagerDuty incident
        shell: bash
        env:
          ROUTING_KEY: ${{ secrets.PAGERDUTY_ROUTING_KEY }}
          FAILURE_COUNT: ${{ needs.probe.outputs.failures || '1' }}
          BASE_URL: ${{ secrets.PROBE_BASE_URL }}
          PROBE_ENVIRONMENT: ${{ needs.probe.outputs.environment || 'production' }}
        run: |
          if [[ -z "${ROUTING_KEY:-}" ]]; then
            echo "PagerDuty routing key not configured; skipping page." >&2
            exit 0
          fi

          summary="Rayon observability probe failure (${PROBE_ENVIRONMENT}, ${FAILURE_COUNT} endpoint(s))"
          details=$(cat <<JSON
{
  "routing_key": "${ROUTING_KEY}",
  "event_action": "trigger",
  "payload": {
    "summary": "${summary}",
    "source": "github-actions",
    "severity": "critical",
    "component": "observability-probes",
    "custom_details": {
      "failures": "${FAILURE_COUNT}",
      "base_url": "${BASE_URL}",
      "environment": "${PROBE_ENVIRONMENT}"
    }
  }
}
JSON
)

          curl --silent --show-error --fail \
            -X POST https://events.pagerduty.com/v2/enqueue \
            -H 'Content-Type: application/json' \
            -d "${details}"
