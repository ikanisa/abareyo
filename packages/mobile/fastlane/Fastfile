fastlane_version '2.224.0'

require 'json'

platform :ios do
  desc 'Builds an internal QA binary using the preview EAS profile'
  lane :preview do
    ensure_env!
    sh 'eas build --profile preview --platform ios --non-interactive'
    sh 'eas submit --profile preview --platform ios --non-interactive --wait'
  end

  desc 'Ships a production IPA to TestFlight via the production EAS profile'
  lane :release do
    ensure_env!
    sh 'eas build --profile production --platform ios --non-interactive'
    sh 'eas submit --profile production --platform ios --non-interactive --wait'
  end
end

private

def ensure_env!
  required = %w[
    IOS_APPLE_ID
    IOS_ASC_APP_ID
    IOS_TEAM_ID
    SUPABASE_URL
    SUPABASE_SERVICE_KEY
    API_BASE_URL
  ]
  missing = required.select { |key| ENV[key].to_s.strip.empty? }
  return if missing.empty?

  UI.user_error!("Missing required env vars: #{missing.join(', ')}")
end
